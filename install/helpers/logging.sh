run_logged() {
    local script="$1"

    export CURRENT_SCRIPT="$script"

    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting: $script" >>"$REPO_INSTALL_LOG_FILE"

    # Use bash -c to create a clean subshell
    bash -c "source '$script'" </dev/null >>"$REPO_INSTALL_LOG_FILE" 2>&1
    
    local exit_code=$?

    if [ $exit_code -eq 0 ]; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Completed: $script" >>"$REPO_INSTALL_LOG_FILE"
        unset CURRENT_SCRIPT
    else
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Failed: $script (exit code: $exit_code)" >>"$REPO_INSTALL_LOG_FILE"
    fi

    return $exit_code
}
